<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FIX MOVIL</title>
<style>
:root {
  --bg: #f8fbff;
  --bg-gradient: linear-gradient(135deg, #f8fbff 0%, #eef4ff 100%);
  --card: rgba(255, 255, 255, 0.92);
  --glass: rgba(255, 255, 255, 0.85);
  --accent: #3b82f6;
  --accent-light: #60a5fa;
  --accent-glow: rgba(59, 130, 246, 0.25);
  --text: #0f172a;
  --text-soft: #475569;
  --border: rgba(59, 130, 246, 0.18);
  --shadow: 0 4px 12px rgba(59, 130, 246, 0.08);
  --shadow-hover: 0 8px 20px rgba(59, 130, 246, 0.12);
  --radius: 14px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg-gradient);
  color: var(--text);
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  min-height: 100vh;
  padding: 1rem 0.5rem;
  font-size: 0.85rem;
}
.header { text-align: center; margin: 0.3rem 0 1.5rem; position: relative; }
.logo-title {
  display: block;
  max-width: 250px;
  width: 70vw;
  margin: 0 auto 0.6rem;
  filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.25));
}
.subtitle {
  font-family: 'Orbitron', sans-serif;
  font-size: clamp(1rem, 3.5vw, 1.8rem);
  font-weight: 900;
  letter-spacing: 3px;
  background: linear-gradient(90deg, #3b82f6, #60a5fa, #a5b4fc);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
.card, .section {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 1rem 1.2rem;
  margin-bottom: 1.2rem;
  box-shadow: var(--shadow);
}
.calendar {
  display: flex;
  justify-content: center;
  gap: 6px;
  overflow-x: auto;
  padding: 0.6rem 0;
  scroll-behavior: smooth;
  margin: 0 auto;
  max-width: 100%;
}
@media (min-width: 768px) { .calendar { max-width: 550px; } }
.calendar::-webkit-scrollbar { height: 5px; }
.calendar::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.35); border-radius: 6px; }
.day {
  min-width: 65px;
  padding: 0.6rem 0.5rem;
  border-radius: 10px;
  text-align: center;
  background: rgba(255, 255, 255, 0.75);
  border: 1px solid var(--border);
  cursor: pointer;
  font-weight: 600;
  color: var(--text-soft);
  flex-shrink: 0;
  font-size: 0.8rem;
}
.day.active {
  background: linear-gradient(135deg, #3b82f6, #60a5fa);
  color: white;
  border: none;
  box-shadow: 0 0 15px rgba(59, 130, 246, 0.35);
}
input, select {
  width: 100%;
  padding: 0.7rem 1rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.8);
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text);
}
input:focus, select:focus {
  outline: none;
  border-color: var(--accent-light);
}
input[type="checkbox"] { transform: scale(1.5); margin: 0 auto; display: block; }
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  margin: 1.2rem 0 1.5rem;
}
button {
  border: none;
  border-radius: 999px;
  padding: 0.6rem 1.2rem;
  font-weight: 700;
  font-size: 0.8rem;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
button.primary {
  background: linear-gradient(90deg, #3b82f6, #60a5fa);
  color: white;
  box-shadow: 0 3px 12px rgba(59, 130, 246, 0.2);
}
button.secondary {
  background: white;
  color: var(--accent);
  border: 1px solid rgba(59, 130, 246, 0.2);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 6px;
}
th {
  color: var(--accent);
  font-weight: 700;
  text-align: left;
  padding: 0 0 0.6rem;
  font-size: 0.8rem;
}
td {
  background: rgba(255, 255, 255, 0.85);
  padding: 0.7rem 0.7rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 0.8rem;
  font-weight: 500;
}
tr.paid td { background: rgba(34, 197, 94, 0.12); border-color: rgba(34, 197, 94, 0.3); }
tr.partial td { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.25); }
tr.expense td { background: rgba(239, 68, 68, 0.12); border-color: rgba(239, 68, 68, 0.3); }
.resumen {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 1rem;
  margin-top: 1.5rem;
}
.resumen div {
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  text-align: center;
  box-shadow: var(--shadow);
  font-size: 0.85rem;
  font-weight: 600;
}
.search-filter {
  display: flex;
  gap: 1rem;
  align-items: center;
}
.search-filter input { flex: 1; }
.search-filter select { flex: 0.8; }
</style>
</head>
<body>
<header class="header">
  <img src="imgFixSist/titleFIX.png" alt="FixMovil" class="logo-title">
</header>
<div class="card">
  <div class="calendar" id="calendar"></div>
</div>
<div class="card search-filter">
  <input id="buscador" placeholder="üîç Buscar cliente..." oninput="buscarCliente()">
  <select id="filtroEstado" onchange="filtrarTabla()">
    <option value="Todo">Todo</option>
    <option value="Pagado">Pagaron</option>
    <option value="Pendiente">No Pagaron</option>
    <option value="Preferencial">Preferenciales</option>
  </select>
</div>
<div class="card actions">
  <button onclick="nuevaVenta()">‚ûï Nueva venta</button>
  <button onclick="nuevoGasto()">üí∏ Nuevo gasto</button>
  <button class="alt" onclick="descargarTXT()">üìÑ TXT Diario</button>
  <button class="alt" onclick="descargarDeudores()">üìÑ TXT Deudores</button>
  <button class="alt" onclick="descargarAdelantos()">TXT Adelanto</button>
  <button class="alt" onclick="document.getElementById('fileTXT').click()">üìÇ Cargar TXT</button>
  <button class="alt" onclick="enviarWhatsApp()">üì≤ TXT Cobrar</button>
  <button class="alt" onclick="resumenPreferenciales()">üìä Resumen Pref.</button>
  <button class="alt" onclick="limpiarDia()">üóëÔ∏è Limpiar D√≠a</button>
</div>
<input type="file" id="fileTXT" accept=".txt" style="display:none" onchange="cargarTXT(event)">
<div class="card">
<table id="tabla">
<thead>
<tr>
<th>Pref.</th>
<th>Cliente/Desc</th>
<th>Modelo</th>
<th>Precio</th>
<th>Cant.</th>
<th>Fecha / Hora</th>
<th>Efectivo</th>
<th>Yape</th>
<th>Saldo</th>
<th>Estado</th>
<th></th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="resumen" id="resumen">
  <div>üíµ Efectivo: S/ <span id="totalEfectivo">0</span></div>
  <div>üì± Yape: S/ <span id="totalYape">0</span></div>
  <div id="gastosDiv" style="display:none">üí∏ Gastos: S/ <span id="totalGastos">0</span></div>
  <div>üí∞ Total: S/ <span id="totalDia">0</span></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, where, deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDn0Dlmu6JPdUKMW4jKx1ljdHp_wB2lJkg",
  authDomain: "fixmovil-26.firebaseapp.com",
  projectId: "fixmovil-26",
  storageBucket: "fixmovil-26.firebasestorage.app",
  messagingSenderId: "951664762630",
  appId: "1:951664762630:web:0f23c5c00a55362a10c887",
  measurementId: "G-78DPDPQMZP"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ventasCollection = collection(db, "ventas");
const gastosCollection = collection(db, "gastos");

let selectedDate = new Date().toISOString().slice(0,10);

const calendar = document.getElementById("calendar");
function renderCalendar(){
  calendar.innerHTML="";
  for(let i=-3;i<=3;i++){
    const d=new Date();
    d.setDate(d.getDate()+i);
    const iso=d.toISOString().slice(0,10);
    const div=document.createElement("div");
    div.className="day"+(iso===selectedDate?" active":"");
    div.innerHTML=`<strong>${d.getDate()}</strong><br>${d.toLocaleDateString("es",{weekday:"short"})}`;
    div.onclick=()=>{selectedDate=iso;renderCalendar();cargarDia()};
    calendar.appendChild(div);
  }
}
renderCalendar();

window.nuevaVenta = async () => {
  const ahora = new Date();
  const fh = ahora.toLocaleDateString('es-PE') + ' ' + ahora.toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit', hour12: true}).replace('.', '');
  const tr = document.createElement('tr');
  tr.classList.add('venta');
  tr.innerHTML = `
<td><input type="checkbox" onchange="togglePreferencial(this)"></td>
<td><input oninput="updLocal(this)"></td>
<td><input oninput="updLocal(this)"></td>
<td><input type="number" value="0" oninput="recalcLocal(this)"></td>
<td><input class="cantidad" type="number" value="1" min="1" oninput="recalcLocal(this)"></td>
<td>${fh}</td>
<td>
  <button onclick="pagoCompletoLocal(this)">S√≠</button>
  <button onclick="activarMonto(this)">Monto</button>
  <input type="number" value="0" style="display:none" oninput="recalcLocal(this)">
</td>
<td>
  <button onclick="pagoCompletoLocal(this)">S√≠</button>
  <button onclick="activarMonto(this)">Monto</button>
  <input type="number" value="0" style="display:none" oninput="recalcLocal(this)">
</td>
<td>0.00</td>
<td>Pendiente</td>
<td><button onclick="delLocal(this)">‚ùå</button></td>`;
  document.querySelector('#tabla tbody').appendChild(tr);
  try {
    const docRef = await addDoc(ventasCollection, {
      fecha: selectedDate,
      cliente: "",
      modelo: "",
      precio: 0,
      cantidad: 1,
      efectivo: 0,
      yape: 0,
      saldo: 0,
      estado: "Pendiente",
      fechaHora: fh,
      timestamp: ahora.getTime(),
      preferencial: false
    });
    tr.dataset.id = docRef.id;
    tr.dataset.type = 'venta';
  } catch (error) { console.error("Error al agregar venta: ", error); }
  recalcLocal(tr.querySelector('input'));
};

window.nuevoGasto = async () => {
  const ahora = new Date();
  const fh = ahora.toLocaleDateString('es-PE') + ' ' + ahora.toLocaleTimeString('es-PE', {hour:'2-digit', minute:'2-digit', hour12: true}).replace('.', '');
  const tr = document.createElement('tr');
  tr.classList.add('expense');
  tr.innerHTML = `
<td><input type="checkbox" onchange="togglePantalla(this)"></td>
<td><input placeholder="Descripci√≥n (pantalla fallada?)" oninput="updLocalGasto(this)"></td>
<td><select onchange="updMetodoGasto(this)"><option value="efectivo">Efectivo</option><option value="yape">Yape</option></select></td>
<td><input type="number" value="0" oninput="recalcGasto(this)"></td>
<td>1</td>
<td>${fh}</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>Gasto</td>
<td><button onclick="delLocal(this)">‚ùå</button></td>`;
  document.querySelector('#tabla tbody').appendChild(tr);
  try {
    const docRef = await addDoc(gastosCollection, {
      fecha: selectedDate,
      descripcion: "",
      monto: 0,
      metodo: "efectivo",
      pantallaFallada: false,
      fechaHora: fh,
      timestamp: ahora.getTime()
    });
    tr.dataset.id = docRef.id;
    tr.dataset.type = 'gasto';
  } catch (error) { console.error("Error al agregar gasto: ", error); }
};

async function cargarDia(){
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";
  let ef = 0, ya = 0, gastos = 0, gastos_ef = 0, gastos_ya = 0;
  let entries = [];
  try {
    const qVentas = query(ventasCollection, where("fecha", "==", selectedDate));
    const snapVentas = await getDocs(qVentas);
    snapVentas.forEach(d => {
      const v = d.data();
      entries.push({ ...v, id: d.id, type: 'venta', timestamp: v.timestamp || parseFechaHoraToTimestamp(v.fechaHora) });
    });
  } catch (error) { console.error("Error al cargar ventas: ", error); }
  try {
    const qGastos = query(gastosCollection, where("fecha", "==", selectedDate));
    const snapGastos = await getDocs(qGastos);
    snapGastos.forEach(d => {
      const g = d.data();
      entries.push({ ...g, id: d.id, type: 'gasto', timestamp: g.timestamp || parseFechaHoraToTimestamp(g.fechaHora) });
    });
  } catch (error) { console.error("Error al cargar gastos: ", error); }
  entries.sort((a, b) => a.timestamp - b.timestamp);
  entries.forEach(entry => {
    const tr = document.createElement("tr");
    tr.dataset.id = entry.id;
    tr.dataset.type = entry.type;
    if (entry.type === 'venta') {
      if (entry.estado === "Pagado") tr.classList.add("paid");
      else if (entry.estado === "Pendiente" && (entry.efectivo + entry.yape > 0)) tr.classList.add("partial");
      tr.innerHTML = `
<td><input type="checkbox" ${entry.preferencial ? 'checked' : ''} onchange="togglePreferencial(this)"></td>
<td><input value="${entry.cliente || ''}" oninput="updLocal(this)"></td>
<td><input value="${entry.modelo || ''}" oninput="updLocal(this)"></td>
<td><input type="number" value="${entry.precio || 0}" oninput="recalcLocal(this)"></td>
<td><input class="cantidad" type="number" value="${entry.cantidad || 1}" oninput="recalcLocal(this)"></td>
<td>${entry.fechaHora || ''}</td>
<td>
  <button onclick="pagoCompletoLocal(this)">S√≠</button>
  <button onclick="activarMonto(this)">Monto</button>
  <input type="number" value="${entry.efectivo || 0}" style="${(entry.efectivo || 0) > 0 ? 'display:block' : 'display:none'}" oninput="recalcLocal(this)">
</td>
<td>
  <button onclick="pagoCompletoLocal(this)">S√≠</button>
  <button onclick="activarMonto(this)">Monto</button>
  <input type="number" value="${entry.yape || 0}" style="${(entry.yape || 0) > 0 ? 'display:block' : 'display:none'}" oninput="recalcLocal(this)">
</td>
<td>${(entry.saldo || 0).toFixed(2)}</td>
<td>${entry.estado || 'Pendiente'}</td>
<td><button onclick="delLocal(this)">‚ùå</button></td>`;
      ef += entry.efectivo || 0;
      ya += entry.yape || 0;
    } else if (entry.type === 'gasto') {
      tr.classList.add("expense");
      tr.innerHTML = `
<td><input type="checkbox" ${entry.pantallaFallada ? 'checked' : ''} onchange="togglePantalla(this)"></td>
<td><input value="${entry.descripcion || ''}" oninput="updLocalGasto(this)"></td>
<td><select onchange="updMetodoGasto(this)"><option value="efectivo" ${entry.metodo === "efectivo" ? 'selected' : ''}>Efectivo</option><option value="yape" ${entry.metodo === "yape" ? 'selected' : ''}>Yape</option></select></td>
<td><input type="number" value="${entry.monto || 0}" oninput="recalcGasto(this)"></td>
<td>1</td>
<td>${entry.fechaHora || ''}</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>Gasto</td>
<td><button onclick="delLocal(this)">‚ùå</button></td>`;
      gastos += entry.monto || 0;
      if (entry.metodo === 'efectivo') gastos_ef += entry.monto || 0;
      if (entry.metodo === 'yape') gastos_ya += entry.monto || 0;
    }
    tbody.appendChild(tr);
  });
  document.getElementById("totalEfectivo").innerText = (ef - gastos_ef).toFixed(2);
  document.getElementById("totalYape").innerText = (ya - gastos_ya).toFixed(2);
  document.getElementById("totalGastos").innerText = gastos.toFixed(2);
  document.getElementById("totalDia").innerText = ((ef - gastos_ef) + (ya - gastos_ya)).toFixed(2);
  document.getElementById("gastosDiv").style.display = gastos > 0 ? 'block' : 'none';
  filtrarTabla();
}
cargarDia();

window.togglePreferencial = (chk) => {
  const tr = chk.closest('tr');
  const id = tr.dataset.id;
  const preferencial = chk.checked;
  if (id) updateDoc(doc(db, "ventas", id), {preferencial}).catch(err => console.error(err));
};

window.updLocal = (el) => {
  const tr = el.closest('tr');
  const id = tr.dataset.id;
  const field = el.parentElement.cellIndex === 1 ? 'cliente' : 'modelo';
  if (id) updateDoc(doc(db, "ventas", id), {[field]: el.value}).catch(err => console.error(err));
};

window.updLocalGasto = (el) => {
  const tr = el.closest('tr');
  const id = tr.dataset.id;
  if (id) updateDoc(doc(db, "gastos", id), {descripcion: el.value}).catch(err => console.error(err));
};

window.updMetodoGasto = (el) => {
  const tr = el.closest('tr');
  const id = tr.dataset.id;
  const metodo = el.value;
  if (id) updateDoc(doc(db, "gastos", id), {metodo}).catch(err => console.error(err));
  actualizarTotalesLocal();
};

window.togglePantalla = (chk) => {
  const tr = chk.closest('tr');
  const id = tr.dataset.id;
  const pantallaFallada = chk.checked;
  if (id) updateDoc(doc(db, "gastos", id), {pantallaFallada}).catch(err => console.error(err));
};

window.recalcLocal = (el) => {
  const tr = el.closest('tr');
  const id = tr.dataset.id;
  const p = +tr.querySelector('td:nth-child(4) input').value || 0;
  const c = +tr.querySelector('td:nth-child(5) input').value || 1;
  const e = +tr.querySelector('td:nth-child(7) input').value || 0;
  const y = +tr.querySelector('td:nth-child(8) input').value || 0;
  const total = p * c;
  const saldo = total - (e + y);
  const estado = saldo <= 0 ? "Pagado" : "Pendiente";
  tr.querySelector('td:nth-child(9)').textContent = saldo.toFixed(2);
  tr.querySelector('td:nth-child(10)').textContent = estado;
  tr.classList.remove("paid", "partial");
  if (estado === "Pagado") tr.classList.add("paid");
  else if (estado === "Pendiente" && (e + y > 0)) tr.classList.add("partial");
  actualizarTotalesLocal();
  if (id) updateDoc(doc(db, "ventas", id), {precio: p, cantidad: c, efectivo: e, yape: y, saldo, estado}).catch(err => console.error(err));
};

window.recalcGasto = (el) => {
  const tr = el.closest('tr');
  const id = tr.dataset.id;
  const monto = +el.value || 0;
  if (id) updateDoc(doc(db, "gastos", id), {monto}).catch(err => console.error(err));
  actualizarTotalesLocal();
};

window.pagoCompletoLocal = (btn) => {
  const tr = btn.closest('tr');
  const p = +tr.querySelector('td:nth-child(4) input').value || 0;
  const c = +tr.querySelector('td:nth-child(5) input').value || 1;
  const total = p * c;
  const input = btn.parentElement.querySelector('input');
  input.value = total;
  input.style.display = 'block';
  recalcLocal(input);
};

window.activarMonto = (btn) => {
  const i = btn.parentElement.querySelector('input');
  i.style.display = 'block';
  i.focus();
};

window.delLocal = (btn) => {
  const tr = btn.closest('tr');
  const id = tr.dataset.id;
  const type = tr.dataset.type;
  if (id && confirm("¬øEliminar?")) {
    deleteDoc(doc(db, type === 'venta' ? "ventas" : "gastos", id)).catch(err => console.error(err));
  }
  tr.remove();
  actualizarTotalesLocal();
};

function actualizarTotalesLocal() {
  let ef = 0, ya = 0, gastos = 0, gastos_ef = 0, gastos_ya = 0;
  document.querySelectorAll('#tabla tbody tr').forEach(tr => {
    if (tr.dataset.type === 'venta') {
      ef += +tr.querySelector('td:nth-child(7) input')?.value || 0;
      ya += +tr.querySelector('td:nth-child(8) input')?.value || 0;
    } else if (tr.dataset.type === 'gasto') {
      const monto = +tr.querySelector('td:nth-child(4) input')?.value || 0;
      gastos += monto;
      const metodo = tr.querySelector('td:nth-child(3) select')?.value || '';
      if (metodo === 'efectivo') gastos_ef += monto;
      if (metodo === 'yape') gastos_ya += monto;
    }
  });
  document.getElementById("totalEfectivo").innerText = (ef - gastos_ef).toFixed(2);
  document.getElementById("totalYape").innerText = (ya - gastos_ya).toFixed(2);
  document.getElementById("totalGastos").innerText = gastos.toFixed(2);
  document.getElementById("totalDia").innerText = ((ef - gastos_ef) + (ya - gastos_ya)).toFixed(2);
  document.getElementById("gastosDiv").style.display = gastos > 0 ? 'block' : 'none';
}

window.filtrarTabla = () => {
  const filtro = document.getElementById("filtroEstado").value;
  document.querySelectorAll("#tabla tbody tr").forEach(tr => {
    if (tr.dataset.type === 'gasto') {
      tr.style.display = (filtro === "Todo" || filtro === "Preferencial") ? "" : "none";
      return;
    }
    const estado = tr.querySelector("td:nth-child(10)").textContent;
    const isPref = tr.querySelector('input[type="checkbox"]').checked;
    if (filtro === "Todo") tr.style.display = "";
    else if (filtro === "Preferencial") tr.style.display = isPref ? "" : "none";
    else tr.style.display = (estado === filtro) ? "" : "none";
  });
};

window.buscarCliente = () => {
  const q = document.getElementById("buscador").value.toLowerCase();
  document.querySelectorAll("#tabla tbody tr").forEach(r => {
    const text = r.children[1].firstChild.value.toLowerCase();
    r.style.display = text.includes(q) ? "" : "none";
  });
};

window.limpiarDia = async () => {
  if (confirm("¬øEliminar todas las ventas y gastos del d√≠a?")) {
    try {
      const qVentas = query(ventasCollection, where("fecha", "==", selectedDate));
      const snapVentas = await getDocs(qVentas);
      const deletesVentas = snapVentas.docs.map(d => deleteDoc(doc(db, "ventas", d.id)));
      const qGastos = query(gastosCollection, where("fecha", "==", selectedDate));
      const snapGastos = await getDocs(qGastos);
      const deletesGastos = snapGastos.docs.map(d => deleteDoc(doc(db, "gastos", d.id)));
      await Promise.all([...deletesVentas, ...deletesGastos]);
      await cargarDia();
    } catch (error) { console.error("Error al limpiar: ", error); }
  }
};

window.descargarTXT = async () => {
  let t = `COBRANZA DIARIA\nFECHA: ${selectedDate}\n----------------\n`;
  try {
    const q = query(ventasCollection, where("fecha", "==", selectedDate));
    const snap = await getDocs(q);
    snap.forEach(d => {
      const v = d.data();
      if (v.estado === 'Pagado') {
        t += `CLIENTE: ${v.cliente}\nMODELO: ${v.modelo}\nCANTIDAD: ${v.cantidad}\nFECHA/HORA: ${v.fechaHora}\nPRECIO: S/${v.precio}\n----------------\n`;
      }
    });
    t += `\nGASTOS:\n`;
    const qGastos = query(gastosCollection, where("fecha", "==", selectedDate));
    const snapGastos = await getDocs(qGastos);
    snapGastos.forEach(d => {
      const g = d.data();
      t += `DESCRIPCI√ìN: ${g.descripcion}\nM√âTODO: ${g.metodo ? g.metodo.toUpperCase() : 'NO ESPECIFICADO'}\nMONTO: S/${g.monto}\nFECHA/HORA: ${g.fechaHora}\n${g.pantallaFallada ? '‚Üí Pantalla fallada' : ''}\n----------------\n`;
    });
    t += `RESUMEN\nEFECTIVO: S/${document.getElementById("totalEfectivo").innerText}\nYAPE: S/${document.getElementById("totalYape").innerText}\nGASTOS: S/${document.getElementById("totalGastos").innerText}\nTOTAL: S/${document.getElementById("totalDia").innerText}`;
    descargarArchivo(t, `cobranza_${selectedDate}.txt`);
  } catch (error) { console.error("Error: ", error); }
};

window.descargarDeudores = async () => {
  let t = `DEUDORES ${selectedDate}\n----------------\n`;
  try {
    const q = query(ventasCollection, where("fecha", "==", selectedDate));
    const snap = await getDocs(q);
    snap.forEach(d => {
      const v = d.data();
      if (v.saldo > 0) {
        t += `CLIENTE: ${v.cliente}\nMODELO: ${v.modelo}\nCANTIDAD: ${v.cantidad}\nFECHA/HORA: ${v.fechaHora}\nDEUDA: S/${v.saldo.toFixed(2)}\n----------------\n`;
      }
    });
    descargarArchivo(t, `deudores_${selectedDate}.txt`);
  } catch (error) { console.error("Error: ", error); }
};

window.descargarAdelantos = async () => {
  let t = `ADELANTOS ${selectedDate}\n----------------\n`;
  let hay = false;
  try {
    const q = query(ventasCollection, where("fecha", "==", selectedDate));
    const snap = await getDocs(q);
    snap.forEach(d => {
      const v = d.data();
      const adelantado = (v.efectivo || 0) + (v.yape || 0);
      if (adelantado > 0 && v.saldo > 0) {
        hay = true;
        t += `CLIENTE: ${v.cliente}\nMODELO: ${v.modelo}\nCANTIDAD: ${v.cantidad}\nFECHA/HORA: ${v.fechaHora}\nADELANTADO: S/${adelantado.toFixed(2)}\nSALDO: S/${v.saldo.toFixed(2)}\n----------------\n`;
      }
    });
    if (!hay) { alert("No hay adelantos este d√≠a"); return; }
    descargarArchivo(t, `adelantos_${selectedDate}.txt`);
  } catch (error) { console.error("Error: ", error); }
};

window.enviarWhatsApp = async () => {
  let mensaje = `üìå *RECORDATORIO DE PAGO*\n\n`;
  let hay = false;
  try {
    const q = query(ventasCollection, where("fecha", "==", selectedDate), where("estado", "==", "Pendiente"));
    const snap = await getDocs(q);
    snap.forEach(d => {
      const v = d.data();
      if (v.saldo > 0) {
        hay = true;
        mensaje += `üë§ Cliente: ${v.cliente}\nüì± Modelo: ${v.modelo}\nüí∞ Saldo: S/${v.saldo.toFixed(2)}\n\n`;
      }
    });
    if (!hay) { alert("No hay deudas pendientes"); return; }
    window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
  } catch (error) { console.error("Error: ", error); }
};

window.resumenPreferenciales = async () => {
  let mensaje = `üìä *RESUMEN CLIENTES PREFERENCIALES*\nFECHA: ${selectedDate}\n\n`;
  let grupos = {};
  try {
    const q = query(ventasCollection, where("fecha", "==", selectedDate), where("preferencial", "==", true));
    const snap = await getDocs(q);
    snap.forEach(d => {
      const v = d.data();
      if (!grupos[v.cliente]) grupos[v.cliente] = { entries: [], total: 0, pagado: 0, saldo: 0 };
      grupos[v.cliente].entries.push(v);
      grupos[v.cliente].total += (v.precio * v.cantidad);
      grupos[v.cliente].pagado += (v.efectivo + v.yape);
      grupos[v.cliente].saldo += v.saldo;
    });
    for (const cliente in grupos) {
      const g = grupos[cliente];
      mensaje += `üë§ ${cliente}\n`;
      g.entries.forEach(e => {
        mensaje += `- Modelo: ${e.modelo}, Cant: ${e.cantidad}, Precio: S/${e.precio}, FH: ${e.fechaHora}\n`;
      });
      mensaje += `Total: S/${g.total.toFixed(2)}\nPagado: S/${g.pagado.toFixed(2)}\nSaldo: S/${g.saldo.toFixed(2)}\n\n`;
    }
    if (Object.keys(grupos).length === 0) { alert("No hay clientes preferenciales"); return; }
    window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
  } catch (error) { console.error("Error: ", error); }
};

function parseFechaHoraToTimestamp(fh) {
  const [fecha, horaAmPm] = fh.split(' ');
  const [dia, mes, ano] = fecha.split('/');
  let [hora, min] = horaAmPm.split(':');
  const ampm = horaAmPm.slice(-4);
  if (ampm === 'p.m.' && hora !== '12') hora = parseInt(hora) + 12;
  if (ampm === 'a.m.' && hora === '12') hora = 0;
  const date = new Date(ano, mes - 1, dia, hora, min);
  return date.getTime();
}

window.cargarTXT = async (ev) => {
  const file = ev.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = async (e) => {
    const bloques = e.target.result.split('----------------');
    for (const b of bloques) {
      const clienteMatch = b.match(/CLIENTE:\s*(.*)/);
      const modeloMatch = b.match(/MODELO:\s*(.*)/);
      const cantidadMatch = b.match(/CANTIDAD:\s*(\d+)/);
      const deudaMatch = b.match(/DEUDA:\s*S\/?([\d.]+)/);
      const fhMatch = b.match(/FECHA\/HORA:\s*(.*)/);
      if (clienteMatch && modeloMatch && deudaMatch) {
        const fh = fhMatch ? fhMatch[1].trim() : new Date().toLocaleString("es-PE", {hour12: true}).replace('.', '');
        const deuda = parseFloat(deudaMatch[1]);
        const cantidad = cantidadMatch ? parseInt(cantidadMatch[1]) : 1;
        const precio = deuda / cantidad;
        const saldo = deuda;
        const estado = saldo <= 0 ? "Pagado" : "Pendiente";
        const timestamp = parseFechaHoraToTimestamp(fh);
        const docRef = await addDoc(ventasCollection, {
          fecha: selectedDate,
          cliente: clienteMatch[1],
          modelo: modeloMatch[1],
          precio: precio,
          cantidad: cantidad,
          efectivo: 0,
          yape: 0,
          saldo: saldo,
          estado: estado,
          fechaHora: fh,
          timestamp: timestamp,
          preferencial: false
        });
        const tr = document.createElement('tr');
        tr.dataset.id = docRef.id;
        tr.dataset.type = 'venta';
        tr.innerHTML = `
<td><input type="checkbox" onchange="togglePreferencial(this)"></td>
<td><input value="${clienteMatch[1]}" oninput="updLocal(this)"></td>
<td><input value="${modeloMatch[1]}" oninput="updLocal(this)"></td>
<td><input type="number" value="${precio}" oninput="recalcLocal(this)"></td>
<td><input class="cantidad" type="number" value="${cantidad}" oninput="recalcLocal(this)"></td>
<td>${fh}</td>
<td>
  <button onclick="pagoCompletoLocal(this)">S√≠</button>
  <button onclick="activarMonto(this)">Monto</button>
  <input type="number" value="0" style="display:none" oninput="recalcLocal(this)">
</td>
<td>
  <button onclick="pagoCompletoLocal(this)">S√≠</button>
  <button onclick="activarMonto(this)">Monto</button>
  <input type="number" value="0" style="display:none" oninput="recalcLocal(this)">
</td>
<td>${saldo.toFixed(2)}</td>
<td>${estado}</td>
<td><button onclick="delLocal(this)">‚ùå</button></td>`;
        document.querySelector('#tabla tbody').appendChild(tr);
        recalcLocal(tr.querySelector('input'));
      }
    }
    cargarDia();
  };
  r.readAsText(file);
};

function descargarArchivo(txt, n) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([txt], {type: 'text/plain'}));
  a.download = n;
  a.click();
}
</script>
</body>
</html>
